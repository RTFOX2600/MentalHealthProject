{% extends 'base.html' %}
{% load static %}

{% block title %}精准思政分析系统 - 演示{% endblock %}

{% block container_class %}container-fluid px-3 px-lg-5{% endblock %}

{% block extra_css %}
<!--suppress ProblematicWhitespace -->
	<link rel="stylesheet" href="{% static 'css/mental_health.css' %}">
{% endblock %}

{% block content_wrapper %}
<div class="mh-container">
    <!-- 头部 -->
    <div class="mh-header fade-in-up" style="animation-delay: 0.1s;">
        <h1 class="display-4 fw-bold">精准思政分析系统</h1>
        <p class="lead text-muted">基于校园行为数据的精准思政分析平台（程序与算法可行性验证）</p>
    </div>

    <!-- 表格上传区 -->
    <div class="mh-section fade-in-up" style="animation-delay: 0.2s;">
        <h2>
            <span class="icon" style="-webkit-mask-image: url('{% static 'icons/upload.svg' %}'); mask-image: url('{% static 'icons/upload.svg' %}');"></span>
            数据表格上传
        </h2>
        <div class="alert alert-info border-0 shadow-sm mb-4">
            <p class="mb-0" style="color: #0f172a">
                可以直接点击底部的分析按钮<strong>使用已有数据</strong>；或上传以下五个表格文件以<strong>覆盖旧数据</strong>。
            </p>
        </div>

        <div class="mh-upload-grid">
            <!-- 1. 食堂消费统计表 -->
            <div class="fade-in-up" style="animation-delay: 0.3s;">
                <div class="upload-item">
                    <h3 class="h6 fw-bold mb-3 d-flex align-items-center gap-2">
                        <span class="icon text-primary" style="-webkit-mask-image: url('{% static 'icons/canteen.svg' %}'); mask-image: url('{% static 'icons/canteen.svg' %}');"></span>
                        1. 食堂消费统计表
                    </h3>
                    <p class="small text-light-dimmed mb-3">格式：学号, 年份-月份, 食堂消费额度（本月）</p>
                    <div class="upload-form" id="canteen-form">
                        <div class="upload-area mb-3">
                            <p class="mb-0 small fw-bold text-primary">点击或拖拽上传</p>
                            <input type="file" id="canteen-file" class="d-none" accept=".csv,.xlsx,.xls">
                        </div>
                        <div id="canteen-file-info" class="selected-file small p-2 border rounded mb-3" style="display: none;"></div>
                        <button class="mh-btn mh-btn-primary" onclick="uploadFile('canteen')" id="btn-upload-canteen" disabled>上传表格</button>
                        <div class="progress mt-3" id="canteen-progress" style="display: none; height: 6px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0"></div>
                        </div>
                        <div class="mh-result mt-3" id="canteen-result"></div>
                    </div>
                </div>
            </div>

            <!-- 2. 校门进出记录表 -->
            <div class="fade-in-up" style="animation-delay: 0.4s;">
                <div class="upload-item">
                    <h3 class="h6 fw-bold mb-3 d-flex align-items-center gap-2">
                        <span class="icon text-primary" style="-webkit-mask-image: url('{% static 'icons/gate.svg' %}'); mask-image: url('{% static 'icons/gate.svg' %}');"></span>
                        2. 校门进出记录表
                    </h3>
                    <p class="small text-light-dimmed mb-3">格式：学号, 校门进出时间, 进出方向, 位置</p>
                    <div class="upload-form" id="school-gate-form">
                        <div class="upload-area mb-3">
                            <p class="mb-0 small fw-bold text-primary">点击或拖拽上传</p>
                            <input type="file" id="school-gate-file" class="d-none" accept=".csv,.xlsx,.xls">
                        </div>
                        <div id="school-gate-file-info" class="selected-file small p-2 border rounded mb-3" style="display: none;"></div>
                        <button class="mh-btn mh-btn-primary" onclick="uploadFile('school-gate')" id="btn-upload-school-gate" disabled>上传表格</button>
                        <div class="progress mt-3" id="school-gate-progress" style="display: none; height: 6px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0"></div>
                        </div>
                        <div class="mh-result mt-3" id="school-gate-result"></div>
                    </div>
                </div>
            </div>

            <!-- 3. 寝室门禁记录表 -->
            <div class="fade-in-up" style="animation-delay: 0.5s;">
                <div class="upload-item">
                    <h3 class="h6 fw-bold mb-3 d-flex align-items-center gap-2">
                        <span class="icon text-primary" style="-webkit-mask-image: url('{% static 'icons/dorm.svg' %}'); mask-image: url('{% static 'icons/dorm.svg' %}');"></span>
                        3. 寝室门禁记录表
                    </h3>
                    <p class="small text-light-dimmed mb-3">格式：学号, 寝室进出时间, 进出方向, 楼栋</p>
                    <div class="upload-form" id="dorm-gate-form">
                        <div class="upload-area mb-3">
                            <p class="mb-0 small fw-bold text-primary">点击或拖拽上传</p>
                            <input type="file" id="dorm-gate-file" class="d-none" accept=".csv,.xlsx,.xls">
                        </div>
                        <div id="dorm-gate-file-info" class="selected-file small p-2 border rounded mb-3" style="display: none;"></div>
                        <button class="mh-btn mh-btn-primary" onclick="uploadFile('dorm-gate')" id="btn-upload-dorm-gate" disabled>上传表格</button>
                        <div class="progress mt-3" id="dorm-gate-progress" style="display: none; height: 6px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0"></div>
                        </div>
                        <div class="mh-result mt-3" id="dorm-gate-result"></div>
                    </div>
                </div>
            </div>

            <!-- 4. 网络访问记录表 -->
            <div class="fade-in-up" style="animation-delay: 0.6s;">
                <div class="upload-item">
                    <h3 class="h6 fw-bold mb-3 d-flex align-items-center gap-2">
                        <span class="icon text-primary" style="-webkit-mask-image: url('{% static 'icons/network.svg' %}'); mask-image: url('{% static 'icons/network.svg' %}');"></span>
                        4. 网络访问记录表
                    </h3>
                    <p class="small text-light-dimmed mb-3">格式：学号, 开始时间, 访问域名, 是否使用VPN</p>
                    <div class="upload-form" id="network-form">
                        <div class="upload-area mb-3">
                            <p class="mb-0 small fw-bold text-primary">点击或拖拽上传</p>
                            <input type="file" id="network-file" class="d-none" accept=".csv,.xlsx,.xls">
                        </div>
                        <div id="network-file-info" class="selected-file small p-2 border rounded mb-3" style="display: none;"></div>
                        <button class="mh-btn mh-btn-primary" onclick="uploadFile('network')" id="btn-upload-network" disabled>上传表格</button>
                        <div class="progress mt-3" id="network-progress" style="display: none; height: 6px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0"></div>
                        </div>
                        <div class="mh-result mt-3" id="network-result"></div>
                    </div>
                </div>
            </div>

            <!-- 5. 各科成绩表 -->
            <div class="fade-in-up" style="animation-delay: 0.7s;">
                <div class="upload-item">
                    <h3 class="h6 fw-bold mb-3 d-flex align-items-center gap-2">
                        <span class="icon text-primary" style="-webkit-mask-image: url('{% static 'icons/grades.svg' %}'); mask-image: url('{% static 'icons/grades.svg' %}');"></span>
                        5. 各科成绩表
                    </h3>
                    <p class="small text-light-dimmed mb-3">格式：学号, 年份-月份, 各课程成绩</p>
                    <div class="upload-form" id="grades-form">
                        <div class="upload-area mb-3">
                            <p class="mb-0 small fw-bold text-primary">点击或拖拽上传</p>
                            <input type="file" id="grades-file" class="d-none" accept=".csv,.xlsx,.xls">
                        </div>
                        <div id="grades-file-info" class="selected-file small p-2 border rounded mb-3" style="display: none;"></div>
                        <button class="mh-btn mh-btn-primary" onclick="uploadFile('grades')" id="btn-upload-grades" disabled>上传表格</button>
                        <div class="progress mt-3" id="grades-progress" style="display: none; height: 6px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0"></div>
                        </div>
                        <div class="mh-result mt-3" id="grades-result"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 数据分析区 -->
    <div class="mh-section fade-in-up" style="animation-delay: 0.8s;">
        <h2>
            <span class="icon" style="-webkit-mask-image: url('{% static 'icons/search.svg' %}'); mask-image: url('{% static 'icons/search.svg' %}');"></span>
            数据分析与处理
        </h2>
        <p class="text-muted mb-4">请配置分析参数后点击对应的分析按钮生成报告。</p>
        
        <!-- 动态参数面板 -->
        <div class="mh-analyze-grid">
            <!-- 综合分析参数 -->
            <div class="mh-param-card mh-param-comp">
                <h4 class="h6 fw-bold mb-3 d-flex align-items-center gap-2 text-primary">
                    <span class="icon" style="-webkit-mask-image: url('{% static 'icons/dollar.svg' %}'); mask-image: url('{% static 'icons/dollar.svg' %}');"></span>
                    综合分析参数
                </h4>
                <div class="mb-3">
	                <label for="param-comp-contamination">风险关注比例</label>
	                <input type="range" class="form-range" id="param-comp-contamination" min="5" max="30" step="1" value="15" data-value-target="val-comp-contamination" data-unit="%">
                    <div class="d-flex justify-content-between small text-muted">
                        <span>5%</span><span>当前: <b id="val-comp-contamination">15%</b></span><span>30%</span>
                    </div>
                </div>
                <div>
                    <label class="form-label small">深夜起始点</label>
                    <div class="custom-dropdown" id="dropdown-comp-night">
                        <div class="dropdown-trigger">
                            <span class="selected-text">23:00</span>
                            <span class="icon" style="-webkit-mask-image: url('{% static 'icons/chevron-down.svg' %}'); mask-image: url('{% static 'icons/chevron-down.svg' %}');"></span>
                        </div>
                        <div class="dropdown-menu">
                            <div class="dropdown-item" data-value="22">22:00</div>
                            <div class="dropdown-item selected" data-value="23">23:00</div>
                            <div class="dropdown-item" data-value="0">00:00</div>
                        </div>
                        <!-- 隐藏的 input 用于实际提交数据 -->
                        <input type="hidden" id="param-comp-night" value="23">
                    </div>
                </div>
            </div>

            <!-- 精准思政参数 (基于论文指标体系) -->
            <div class="mh-param-card mh-param-ideo">
                <h4 class="h6 fw-bold mb-3 d-flex align-items-center gap-2" style="color: #d63384;">
                    <span class="icon" style="-webkit-mask-image: url('{% static 'icons/shield-heart.svg' %}'); mask-image: url('{% static 'icons/shield-heart.svg' %}');"></span>
                    精准思政参数
                </h4>
                <div class="row g-2 mb-2">
                    <div class="col-6">
                        <label for="param-ideo-pos-high" class="form-label small mb-1">正向判定线</label>
                        <div class="numeric-stepper">
                            <button type="button" class="stepper-btn" onclick="adjustStepper('param-ideo-pos-high', -0.5)">
                                <span class="icon" style="-webkit-mask-image: url('{% static 'icons/minus.svg' %}'); mask-image: url('{% static 'icons/minus.svg' %}');"></span>
                            </button>
                            <input type="number" class="stepper-input" id="param-ideo-pos-high" value="4.0" step="0.5">
                            <button type="button" class="stepper-btn" onclick="adjustStepper('param-ideo-pos-high', 0.5)">
                                <span class="icon" style="-webkit-mask-image: url('{% static 'icons/plus.svg' %}'); mask-image: url('{% static 'icons/plus.svg' %}');"></span>
                            </button>
                        </div>
                    </div>
                    <div class="col-6">
                        <label for="param-ideo-pos-low" class="form-label small mb-1">负向判定线</label>
                        <div class="numeric-stepper">
                            <button type="button" class="stepper-btn" onclick="adjustStepper('param-ideo-pos-low', -0.5)">
                                <span class="icon" style="-webkit-mask-image: url('{% static 'icons/minus.svg' %}'); mask-image: url('{% static 'icons/minus.svg' %}');"></span>
                            </button>
                            <input type="number" class="stepper-input" id="param-ideo-pos-low" value="-2.0" step="0.5">
                            <button type="button" class="stepper-btn" onclick="adjustStepper('param-ideo-pos-low', 0.5)">
                                <span class="icon" style="-webkit-mask-image: url('{% static 'icons/plus.svg' %}'); mask-image: url('{% static 'icons/plus.svg' %}');"></span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="row g-2 mb-2">
                    <div class="col-6">
                        <label for="param-ideo-emo-high" class="form-label small mb-1">情绪强度(强)</label>
                        <div class="numeric-stepper">
                            <button type="button" class="stepper-btn" onclick="adjustStepper('param-ideo-emo-high', -0.1)">
                                <span class="icon" style="-webkit-mask-image: url('{% static 'icons/minus.svg' %}'); mask-image: url('{% static 'icons/minus.svg' %}');"></span>
                            </button>
                            <input type="number" class="stepper-input" id="param-ideo-emo-high" value="1.2" step="0.1">
                            <button type="button" class="stepper-btn" onclick="adjustStepper('param-ideo-emo-high', 0.1)">
                                <span class="icon" style="-webkit-mask-image: url('{% static 'icons/plus.svg' %}'); mask-image: url('{% static 'icons/plus.svg' %}');"></span>
                            </button>
                        </div>
                    </div>
                    <div class="col-6">
                        <label for="param-ideo-emo-low" class="form-label small mb-1">情绪强度(弱)</label>
                        <div class="numeric-stepper">
                            <button type="button" class="stepper-btn" onclick="adjustStepper('param-ideo-emo-low', -0.1)">
                                <span class="icon" style="-webkit-mask-image: url('{% static 'icons/minus.svg' %}'); mask-image: url('{% static 'icons/minus.svg' %}');"></span>
                            </button>
                            <input type="number" class="stepper-input" id="param-ideo-emo-low" value="0.8" step="0.1">
                            <button type="button" class="stepper-btn" onclick="adjustStepper('param-ideo-emo-low', 0.1)">
                                <span class="icon" style="-webkit-mask-image: url('{% static 'icons/plus.svg' %}'); mask-image: url('{% static 'icons/plus.svg' %}');"></span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="row g-2">
                    <div class="col-6">
                        <label for="param-ideo-rad-high" class="form-label small mb-1">激进度(强)</label>
                        <div class="numeric-stepper">
                            <button type="button" class="stepper-btn" onclick="adjustStepper('param-ideo-rad-high', -0.5)">
                                <span class="icon" style="-webkit-mask-image: url('{% static 'icons/minus.svg' %}'); mask-image: url('{% static 'icons/minus.svg' %}');"></span>
                            </button>
                            <input type="number" class="stepper-input" id="param-ideo-rad-high" value="4.0" step="0.5">
                            <button type="button" class="stepper-btn" onclick="adjustStepper('param-ideo-rad-high', 0.5)">
                                <span class="icon" style="-webkit-mask-image: url('{% static 'icons/plus.svg' %}'); mask-image: url('{% static 'icons/plus.svg' %}');"></span>
                            </button>
                        </div>
                    </div>
                    <div class="col-6">
                        <label for="param-ideo-rad-low" class="form-label small mb-1">激进度(弱)</label>
                        <div class="numeric-stepper">
                            <button type="button" class="stepper-btn" onclick="adjustStepper('param-ideo-rad-low', -0.5)">
                                <span class="icon" style="-webkit-mask-image: url('{% static 'icons/minus.svg' %}'); mask-image: url('{% static 'icons/minus.svg' %}');"></span>
                            </button>
                            <input type="number" class="stepper-input" id="param-ideo-rad-low" value="1.5" step="0.5">
                            <button type="button" class="stepper-btn" onclick="adjustStepper('param-ideo-rad-low', 0.5)">
                                <span class="icon" style="-webkit-mask-image: url('{% static 'icons/plus.svg' %}'); mask-image: url('{% static 'icons/plus.svg' %}');"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 精准扶贫参数 -->
            <div class="mh-param-card mh-param-pov">
                <h4 class="h6 fw-bold mb-3 d-flex align-items-center gap-2" style="color: #198754;">
                    <span class="icon" style="-webkit-mask-image: url('{% static 'icons/dollar.svg' %}'); mask-image: url('{% static 'icons/dollar.svg' %}');"></span>
                    精准扶贫参数
                </h4>
                <div class="mb-3">
                    <label for="param-pov-threshold" class="form-label small">贫困消费阈值 (元)</label>
                    <div class="numeric-stepper">
                        <button type="button" class="stepper-btn" onclick="adjustStepper('param-pov-threshold', -50)">
                            <span class="icon" style="-webkit-mask-image: url('{% static 'icons/minus.svg' %}'); mask-image: url('{% static 'icons/minus.svg' %}');"></span>
                        </button>
                        <input type="number" class="stepper-input" id="param-pov-threshold" value="300" step="50">
                        <button type="button" class="stepper-btn" onclick="adjustStepper('param-pov-threshold', 50)">
                            <span class="icon" style="-webkit-mask-image: url('{% static 'icons/plus.svg' %}'); mask-image: url('{% static 'icons/plus.svg' %}');"></span>
                        </button>
                    </div>
                    <div class="form-text small text-light-dimmed" style="font-size: 0.7rem;">用于阶梯判定特别/一般困难</div>
                </div>
                <div>
                    <label for="param-pov-trend" class="form-label small">趋势下降警戒线</label>
                    <div class="numeric-stepper">
                        <button type="button" class="stepper-btn" onclick="adjustStepper('param-pov-trend', -5)">
                            <span class="icon" style="-webkit-mask-image: url('{% static 'icons/minus.svg' %}'); mask-image: url('{% static 'icons/minus.svg' %}');"></span>
                        </button>
                        <input type="number" class="stepper-input" id="param-pov-trend" value="-50" step="5">
                        <button type="button" class="stepper-btn" onclick="adjustStepper('param-pov-trend', 5)">
                            <span class="icon" style="-webkit-mask-image: url('{% static 'icons/plus.svg' %}'); mask-image: url('{% static 'icons/plus.svg' %}');"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

	    <!-- 开始按钮 -->
        <div class="mh-action-buttons">
            <button class="mh-btn mh-btn-analyze mh-btn-primary" onclick="startAnalysis('comprehensive')" id="btn-comp">
                <span class="btn-text">开始综合分析</span>
            </button>
            <button class="mh-btn mh-btn-analyze" onclick="startAnalysis('ideology')" id="btn-ideo" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: #000;">
                <span class="btn-text">开始精准思政分析</span>
            </button>
            <button class="mh-btn mh-btn-analyze" onclick="startAnalysis('poverty')" id="btn-pov" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: #fff;">
                <span class="btn-text">开始精准扶贫分析</span>
            </button>
        </div>
        <div id="analyse-result" class="mh-result"></div>
    </div>
</div>

<!-- 通知提示组件 -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="mh-toast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="mh-toast-body"></div>
            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/mental_health_demo.js' %}"></script>
{% endblock %}
