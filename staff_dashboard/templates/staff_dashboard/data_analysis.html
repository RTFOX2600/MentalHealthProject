{% extends 'staff_dashboard/base.html' %}
{% load static %}

{% block title %}数据分析 - 工作台{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/data_analysis.css' %}">
{% endblock %}

{% block dashboard_content %}
<!-- 数据配置，供 JS 读取 -->
<div id="data-analysis-config" 
     data-api-url="{% url 'staff_dashboard:api_student_list' %}" 
     style="display: none;">
</div>

<div class="page-header fade-in-up" style="animation-delay: 0.1s;">
    <h2 style="min-width: 200px;">数据分析</h2>
	<a href="{% url 'staff_dashboard:data_analysis_help' %}" class="btn btn-secondary" style="display: inline-flex; align-items: center; gap: 0.5rem; max-width: 150px;">
	    <span class="icon" style="-webkit-mask-image: url('{% static 'icons/help-circle.svg' %}'); mask-image: url('{% static 'icons/help-circle.svg' %}'); background-color: var(--primary-color); width: 20px; height: 20px; margin-right: 0;"></span>
	    使用帮助
	</a>
</div>


<!-- 筛选条件 - 第一部分（基础筛选） -->
<div class="filter-card-top fade-in-up" style="animation-delay: 0.2s;">
    <div class="row g-3">
        <div class="col-12 col-md-6 col-lg-3">
            <label class="form-label">学院</label>
            <div class="custom-dropdown" id="dropdown-college">
                <div class="dropdown-trigger">
                    <span class="selected-text">{% if colleges %}{{ colleges.0.name }}{% else %}全部学院{% endif %}</span>
                    <span class="icon" style="-webkit-mask-image: url('{% static 'icons/chevron-down.svg' %}'); mask-image: url('{% static 'icons/chevron-down.svg' %}');"></span>
                </div>
                <div class="dropdown-menu">
                    <div class="dropdown-item" data-value="">全部学院</div>
                    {% for college in colleges %}
                    <div class="dropdown-item{% if forloop.first %} selected{% endif %}" data-value="{{ college.id }}">{{ college.name }}</div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="col-12 col-md-6 col-lg-3">
            <label class="form-label">专业</label>
            <div class="custom-dropdown" id="dropdown-major">
                <div class="dropdown-trigger">
                    <span class="selected-text">{% if majors %}{{ majors.0.name }}{% else %}全部专业{% endif %}</span>
                    <span class="icon" style="-webkit-mask-image: url('{% static 'icons/chevron-down.svg' %}'); mask-image: url('{% static 'icons/chevron-down.svg' %}');"></span>
                </div>
                <div class="dropdown-menu">
                    <div class="dropdown-item" data-value="">全部专业</div>
                    {% for major in majors %}
                    <div class="dropdown-item{% if forloop.first %} selected{% endif %}" data-value="{{ major.id }}">{{ major.name }}</div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="col-12 col-md-6 col-lg-3">
            <label class="form-label">年级</label>
            <div class="custom-dropdown" id="dropdown-grade">
                <div class="dropdown-trigger">
                    <span class="selected-text">{% if grades %}{{ grades.0.name }}{% else %}全部年级{% endif %}</span>
                    <span class="icon" style="-webkit-mask-image: url('{% static 'icons/chevron-down.svg' %}'); mask-image: url('{% static 'icons/chevron-down.svg' %}');"></span>
                </div>
                <div class="dropdown-menu">
                    <div class="dropdown-item" data-value="">全部年级</div>
                    {% for grade in grades %}
                    <div class="dropdown-item{% if forloop.first %} selected{% endif %}" data-value="{{ grade.id }}">{{ grade.name }}</div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="col-12 col-md-6 col-lg-3">
            <label class="form-label">搜索</label>
            <input type="text" id="filter-search" placeholder="学号或姓名" class="form-control">
        </div>
    </div>
</div>

<!-- 筛选条件 - 第二部分（数据表和时间） -->
<div class="filter-card-bottom fade-in-up" style="animation-delay: 0.25s;">
    <div class="row g-3">
        <div class="col-12 col-md-6 col-lg-3">
            <label class="form-label">数据表</label>
            <div class="custom-dropdown" id="dropdown-data-table">
                <div class="dropdown-trigger">
                    <span class="selected-text">学生基本信息</span>
                    <span class="icon" style="-webkit-mask-image: url('{% static 'icons/chevron-down.svg' %}'); mask-image: url('{% static 'icons/chevron-down.svg' %}');"></span>
                </div>
                <div class="dropdown-menu">
                    <div class="dropdown-item selected" data-value="basic">学生基本信息</div>
                    <div class="dropdown-item" data-value="canteen">食堂消费记录</div>
                    <div class="dropdown-item" data-value="school_gate">校门门禁记录</div>
                    <div class="dropdown-item" data-value="dormitory">寝室门禁记录</div>
                    <div class="dropdown-item" data-value="network">网络访问记录</div>
                    <div class="dropdown-item" data-value="academic">成绩记录</div>
                </div>
            </div>
        </div>
        
        <div class="col-12 col-md-6 col-lg-3">
            <label class="form-label">开始时间</label>
            <input type="date" id="filter-start-date" class="form-control">
        </div>
        
        <div class="col-12 col-md-6 col-lg-3">
            <label class="form-label">结束时间</label>
            <input type="date" id="filter-end-date" class="form-control">
        </div>
        
        <div class="col-12 col-md-6 col-lg-3 d-flex align-items-end">
            <button class="btn btn-primary w-100" onclick="applyFilters()">查询</button>
        </div>
    </div>
</div>

<!-- 信息列表 -->
<div class="table-card fade-in-up" style="animation-delay: 0.3s;">
    <div class="table-header">
        <h3>信息列表</h3>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <div class="custom-dropdown" id="dropdown-page-size" style="min-width: 120px;">
                <div class="dropdown-trigger">
                    <span class="selected-text">20 条/页</span>
                    <span class="icon" style="-webkit-mask-image: url('{% static 'icons/chevron-down.svg' %}'); mask-image: url('{% static 'icons/chevron-down.svg' %}');"></span>
                </div>
                <div class="dropdown-menu">
                    <div class="dropdown-item" data-value="10">10 条/页</div>
                    <div class="dropdown-item" data-value="15">15 条/页</div>
                    <div class="dropdown-item selected" data-value="20">20 条/页</div>
                    <div class="dropdown-item" data-value="25">25 条/页</div>
                    <div class="dropdown-item" data-value="30">30 条/页</div>
                    <div class="dropdown-item" data-value="50">50 条/页</div>
                </div>
            </div>
            <div class="table-info" id="table-info">总计 {{ total_students }} 人</div>
        </div>
    </div>
    
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th class="sortable" data-field="student_id" onclick="sortTable('student_id')">学号</th>
                    <th class="sortable" data-field="name" onclick="sortTable('name')">姓名</th>
                    <th class="sortable" data-field="college" onclick="sortTable('college')">学院</th>
                    <th class="sortable" data-field="major" onclick="sortTable('major')">专业</th>
                    <th class="sortable" data-field="grade" onclick="sortTable('grade')">年级</th>
                </tr>
            </thead>
            <tbody id="student-table-body">
                <tr>
                    <td colspan="5" class="empty">数据为空</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="pagination" id="pagination">
        <!-- 分页按钮将由JS动态生成 -->
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="{% static 'js/input_components.js' %}"></script>
<script src="{% static 'js/data_analysis.js' %}"></script>
{% endblock %}
