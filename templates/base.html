{% load static %}
<!DOCTYPE html>
<!--suppress ProblematicWhitespace -->
<html lang="zh-hans">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>{% block title %}精准思政系统{% endblock %}</title>
	<link rel="shortcut icon" href="{% static 'favicon.svg' %}">
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/variables.css' %}">
    <link rel="stylesheet" href="{% static 'css/animations.css' %}">
    <link rel="stylesheet" href="{% static 'css/navbar.css' %}">
    <link rel="stylesheet" href="{% static 'css/input_components.css' %}">
    <link rel="stylesheet" href="{% static 'css/messages.css' %}">
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    {% block extra_css %}{% endblock %}
</head>
<body>
<div id="loader-wrapper" class="loader-visible">
    <span class="loader"></span>
</div>
<nav class="navbar">
	<a href="{% url 'home' %}" class="navbar-brand">精准思政系统</a>
	<div class="nav-links">
		<a href="{% url 'home' %}" class="{% if current_page == 'home' %}active{% endif %}">
            <span class="icon" style="-webkit-mask-image: url('{% static 'icons/home.svg' %}'); mask-image: url('{% static 'icons/home.svg' %}');"></span>
            首页
        </a>
        <a href="{% url 'about' %}" class="{% if current_page == 'about' %}active{% endif %}">
            <span class="icon" style="-webkit-mask-image: url('{% static 'icons/info.svg' %}'); mask-image: url('{% static 'icons/info.svg' %}');"></span>
            关于
        </a>
		{% if user.is_authenticated %}
			{% if user.is_staff %}
				<a href="{% url 'admin:index' %}" target="_blank">
                    <span class="icon" style="-webkit-mask-image: url('{% static 'icons/shield.svg' %}'); mask-image: url('{% static 'icons/shield.svg' %}');"></span>
                    管理后台
                </a>
			{% endif %}
			{% if user.role == 'counselor' or user.role == 'admin' %}
				<a href="{% url 'staff_dashboard:home' %}" class="{% if navbar_page == 'dashboard' %}active{% endif %}">
                    <span class="icon" style="-webkit-mask-image: url('{% static 'icons/briefcase.svg' %}'); mask-image: url('{% static 'icons/briefcase.svg' %}');"></span>
                    工作台
                </a>
			{% endif %}
            <div class="dropdown">
                <div class="nav-user">
                    <span class="icon" style="-webkit-mask-image: url('{% static 'icons/user.svg' %}'); mask-image: url('{% static 'icons/user.svg' %}'); margin-right: 0.15rem;"></span>
                    {{ user.username }}
                    <svg style="width: 16px; height: 16px; margin-left: 0.15rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                <div class="dropdown-content">
                    <a href="{% url 'profile_update' %}">
                        <span class="icon" style="-webkit-mask-image: url('{% static 'icons/user.svg' %}'); mask-image: url('{% static 'icons/user.svg' %}');"></span>
                        修改个人信息
                    </a>
                    <a href="{% url 'password_change' %}">
                        <span class="icon" style="-webkit-mask-image: url('{% static 'icons/lock.svg' %}'); mask-image: url('{% static 'icons/lock.svg' %}');"></span>
                        修改密码
                    </a>
                    <a href="{% url 'delete_account' %}" class="delete-account">
                        <span class="icon" style="-webkit-mask-image: url('{% static 'icons/trash.svg' %}'); mask-image: url('{% static 'icons/trash.svg' %}');"></span>
                        注销账号
                    </a>
                    <hr style="border: 0; border-top: 1px solid var(--primary-color); margin: 0;">
                    <form action="{% url 'logout' %}" method="post" id="logout-form" style="display:none;">
                        {% csrf_token %}
                    </form>
                    <a href="javascript:void(0)" onclick="document.getElementById('logout-form').submit();">
                        <span class="icon" style="-webkit-mask-image: url('{% static 'icons/logout.svg' %}'); mask-image: url('{% static 'icons/logout.svg' %}');"></span>
                        退出登录
                    </a>
                </div>
            </div>
		{% else %}
			<a href="{% url 'login' %}">
                <span class="icon" style="-webkit-mask-image: url('{% static 'icons/login.svg' %}'); mask-image: url('{% static 'icons/login.svg' %}');"></span>
                登录
            </a>
			<a href="{% url 'register' %}">
                <span class="icon" style="-webkit-mask-image: url('{% static 'icons/user-plus.svg' %}'); mask-image: url('{% static 'icons/user-plus.svg' %}');"></span>
                注册
            </a>
		{% endif %}
	</div>
</nav>
<!-- 全局消息提示区域 -->
<div class="messages-container" id="messages-container">
    {% if messages %}
        {% for message in messages %}
            <div class="alert-message alert-{{ message.tags }}" role="alert">
                <span class="alert-icon">
                    {% if message.tags == 'success' %}✔{% endif %}
                    {% if message.tags == 'error' or message.tags == 'danger' %}✖{% endif %}
                    {% if message.tags == 'warning' %}⚠{% endif %}
                    {% if message.tags == 'info' %}ⓘ{% endif %}
                </span>
                <span class="alert-text">{{ message }}</span>
                <button class="alert-close" onclick="closeMessageButton(this)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
        {% endfor %}
    {% endif %}
</div>
<div class="{% block container_class %}container{% endblock %}">
    {% block content_wrapper %}
	<div class="card">
		{% block content %}{% endblock %}
	</div>
    {% endblock %}
</div>

<!-- 全局确认对话框 -->
<div id="globalConfirmDialog" class="global-confirm-dialog">
    <div class="dialog-overlay"></div>
    <div class="dialog-content">
        <h3 id="dialogTitle" class="dialog-title"></h3>
        <p id="dialogMessage" class="dialog-message"></p>
        <div class="dialog-buttons">
            <button type="button" id="dialogSecondaryBtn" class="btn btn-secondary"></button>
            <button type="button" id="dialogPrimaryBtn" class="btn btn-primary"></button>
        </div>
    </div>
</div>

<div class="footer-text">
    <p>2026 · 武汉轻工大学 · 精准思政系统</p>
</div>
<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'js/input_components.js' %}"></script>
{% block extra_js %}{% endblock %}
<!--suppress JSUnusedLocalSymbols -->
<script>
    // ==============================================
    // 关闭消息函数（供按钮调用）
    // ==============================================
    function closeMessageButton(button) {
        const message = button.parentElement;
        message.classList.add('fade-out');
        setTimeout(function() {
            message.remove();
        }, 300); // 等待动画完成
    }

    // ==============================================
    // 消息提示自动消失逻辑（支持悬停暂停）
    // ==============================================
    document.addEventListener('DOMContentLoaded', function() {
        const messages = document.querySelectorAll('.alert-message');
        
        messages.forEach(function(message, index) {
            // 为每个消息设置延迟显示，实现逐个弹出效果
            message.style.animationDelay = (index * 0.1) + 's';
            
            let timeoutId = null;
            let remainingTime = 5000 + (index * 100);
            let startTime = Date.now();
            
            // 启动自动消失定时器
            function startTimer() {
                startTime = Date.now();
                timeoutId = setTimeout(function() {
                    message.classList.add('fade-out');
                    setTimeout(function() {
                        message.remove();
                    }, 300);
                }, remainingTime);
            }
            
            // 暂停定时器
            function pauseTimer() {
                if (timeoutId) {
                    clearTimeout(timeoutId);
                    remainingTime -= (Date.now() - startTime);
                }
            }
            
            // 恢复定时器
            function resumeTimer() {
                if (remainingTime > 0) {
                    startTimer();
                }
            }
            
            // 鼠标悬停时暂停
            message.addEventListener('mouseenter', pauseTimer);
            
            // 鼠标离开时恢复
            message.addEventListener('mouseleave', resumeTimer);
            
            // 启动初始定时器
            startTimer();
        });
    });

    // ==============================================
    // 全局消息提示函数
    // ==============================================
    /**
     * 显示消息提示
     * @param {string} message - 消息内容
     * @param {string} type - 消息类型（info/success/warning/error）
     * @param {number} duration - 显示时长（毫秒），0 表示不自动消失
     * @returns {string} 消息ID，可用于后续关闭
     */
    function showMessage(message, type, duration) {
        type = type || 'info';
        duration = duration !== undefined ? duration : 5000;
        
        const container = document.getElementById('messages-container');
        if (!container) return null;
        
        const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        
        // 确定图标
        let icon = 'ⓘ'; // info
        if (type === 'success') icon = '✔';
        else if (type === 'error' || type === 'danger') icon = '✖';
        else if (type === 'warning') icon = '⚠';
        
        const alertDiv = document.createElement('div');
        alertDiv.id = messageId;
        alertDiv.className = 'alert-message alert-' + type;
        alertDiv.setAttribute('role', 'alert');
        
        // 创建完整的消息结构
        alertDiv.innerHTML = 
            '<span class="alert-icon">' + icon + '</span>' +
            '<span class="alert-text">' + message + '</span>' +
            '<button class="alert-close" onclick="window.closeMessage(\'' + messageId + '\')">' +
                '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">' +
                    '<line x1="18" y1="6" x2="6" y2="18"></line>' +
                    '<line x1="6" y1="6" x2="18" y2="18"></line>' +
                '</svg>' +
            '</button>';
        
        container.appendChild(alertDiv);
        
        // 如果设置了时长，自动消失
        if (duration > 0) {
            setTimeout(function() {
                closeMessage(messageId);
            }, duration);
        }
        
        return messageId;
    }

    /**
     * 关闭消息提示
     * @param {string} messageId - 消息ID
     */
    function closeMessage(messageId) {
        if (!messageId) return;
        
        const messageEl = document.getElementById(messageId);
        if (!messageEl) return;
        
        messageEl.classList.add('fade-out');
        setTimeout(function() {
            messageEl.remove();
        }, 300);
    }

    // ==============================================
    // 全局确认对话框函数
    // ==============================================
    /**
     * 显示全局确认对话框
     * @param {Object} options - 配置选项
     * @param {string} options.title - 对话框标题
     * @param {string} options.message - 对话框消息内容
     * @param {string} options.primaryText - 主要按钮文本（为空则隐藏）
     * @param {string} options.secondaryText - 次要按钮文本（为空则隐藏）
     * @param {Function} options.onPrimary - 主要按钮点击回调
     * @param {Function} options.onSecondary - 次要按钮点击回调
     */
    function showConfirmDialog(options) {
        const dialog = document.getElementById('globalConfirmDialog');
        const title = document.getElementById('dialogTitle');
        const message = document.getElementById('dialogMessage');
        const primaryBtn = document.getElementById('dialogPrimaryBtn');
        const secondaryBtn = document.getElementById('dialogSecondaryBtn');
        
        // 设置标题和消息
        title.textContent = options.title || '';
        message.textContent = options.message || '';
        
        // 配置主要按钮
        if (options.primaryText) {
            primaryBtn.textContent = options.primaryText;
            primaryBtn.style.display = 'block';
            primaryBtn.onclick = function() {
                hideConfirmDialog();
                if (options.onPrimary) options.onPrimary();
            };
        } else {
            primaryBtn.style.display = 'none';
        }
        
        // 配置次要按钮
        if (options.secondaryText) {
            secondaryBtn.textContent = options.secondaryText;
            secondaryBtn.style.display = 'block';
            secondaryBtn.onclick = function() {
                hideConfirmDialog();
                if (options.onSecondary) options.onSecondary();
            };
        } else {
            secondaryBtn.style.display = 'none';
        }
        
        // 显示对话框
        dialog.classList.add('dialog-visible');
        document.body.style.overflow = 'hidden'; // 禁止页面滚动
    }

    /**
     * 隐藏全局确认对话框
     */
    function hideConfirmDialog() {
        const dialog = document.getElementById('globalConfirmDialog');
        dialog.classList.remove('dialog-visible');
        document.body.style.overflow = ''; // 恢复页面滚动
    }

    // 点击蒙版关闭对话框
    document.querySelector('.dialog-overlay')?.addEventListener('click', hideConfirmDialog);

    // 暴露到全局，供各页面调用
    window.showMessage = showMessage;
    window.closeMessage = closeMessage;
    window.showConfirmDialog = showConfirmDialog;
    window.hideConfirmDialog = hideConfirmDialog;

    // 隐藏加载动画的函数
    function hideLoader() {
        const loader = document.getElementById('loader-wrapper');
        if (loader) {
            loader.classList.remove('loader-visible');
        }
    }

    // 页面完全加载后隐藏
    window.addEventListener('load', hideLoader);

    // 处理浏览器前进/后退按钮 (bfcache)
    window.addEventListener('pageshow', function(event) {
        // 如果页面是从缓存中恢复的，强制隐藏加载动画
        hideLoader();
    });

    // 页面跳转时显示加载动画（但排除某些特殊情况）
    let isNonNavigationClick = false;
    
    document.addEventListener('click', function(e) {
        const link = e.target.closest('a');
        if (link && link.href) {
            // 检测是否为不导致页面跳转的链接
            if (link.hasAttribute('download') || 
                link.href.startsWith('mailto:') || 
                link.href.startsWith('tel:') ||
                link.target === '_blank') {
                isNonNavigationClick = true;
                // 100ms 后重置标记
                setTimeout(() => { isNonNavigationClick = false; }, 100);
            }
        }
    }, true);  // 使用捕获阶段，确保在 beforeunload 之前执行

    window.addEventListener('beforeunload', function() {
        if (!isNonNavigationClick) {
            document.getElementById('loader-wrapper').classList.add('loader-visible');
        }
    });

    // 兼容部分浏览器点击链接不触发 beforeunload 的情况
    document.addEventListener('click', function(e) {
        const link = e.target.closest('a');
        if (link && 
            link.href && 
            link.href.startsWith(window.location.origin) && 
            !link.target && 
            !link.href.includes('#') &&
            !link.href.includes('javascript:') &&
            !link.hasAttribute('download') &&  // 排除下载链接
            !link.href.startsWith('mailto:') &&  // 排除邮件链接
            !link.href.startsWith('tel:')) {  // 排除电话链接
            document.getElementById('loader-wrapper').classList.add('loader-visible');
        }
    });
</script>
</body>
</html>
