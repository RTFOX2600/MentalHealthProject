{% load static %}
<!DOCTYPE html>
<!--suppress ProblematicWhitespace -->
<html lang="zh-hans">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>{% block title %}精准思政系统{% endblock %}</title>
	<link rel="shortcut icon" href="{% static 'favicon.svg' %}">
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/variables.css' %}">
    <link rel="stylesheet" href="{% static 'css/animations.css' %}">
    <link rel="stylesheet" href="{% static 'css/navbar.css' %}">
    <link rel="stylesheet" href="{% static 'css/input_components.css' %}">
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    {% block extra_css %}{% endblock %}
</head>
<body>
<div id="loader-wrapper" class="loader-visible">
    <span class="loader"></span>
</div>
<nav class="navbar">
	<a href="{% url 'home' %}" class="navbar-brand">精准思政系统</a>
	<div class="nav-links">
		<a href="{% url 'home' %}">
            <span class="icon" style="-webkit-mask-image: url('{% static 'icons/home.svg' %}'); mask-image: url('{% static 'icons/home.svg' %}');"></span>
            首页
        </a>
        <a href="{% url 'about' %}">
            <span class="icon" style="-webkit-mask-image: url('{% static 'icons/info.svg' %}'); mask-image: url('{% static 'icons/info.svg' %}');"></span>
            关于
        </a>
		{% if user.is_authenticated %}
			{% if user.is_staff %}
				<a href="{% url 'admin:index' %}" target="_blank">
                    <span class="icon" style="-webkit-mask-image: url('{% static 'icons/shield.svg' %}'); mask-image: url('{% static 'icons/shield.svg' %}');"></span>
                    管理后台
                </a>
			{% endif %}
            <div class="dropdown">
                <div class="nav-user">
                    <span class="icon" style="-webkit-mask-image: url('{% static 'icons/user.svg' %}'); mask-image: url('{% static 'icons/user.svg' %}'); margin-right: 0.15rem;"></span>
                    {{ user.username }}
                    <svg style="width: 16px; height: 16px; margin-left: 0.15rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                <div class="dropdown-content">
                    <a href="{% url 'profile_update' %}">
                        <span class="icon" style="-webkit-mask-image: url('{% static 'icons/user.svg' %}'); mask-image: url('{% static 'icons/user.svg' %}');"></span>
                        修改个人信息
                    </a>
                    <a href="{% url 'password_change' %}">
                        <span class="icon" style="-webkit-mask-image: url('{% static 'icons/lock.svg' %}'); mask-image: url('{% static 'icons/lock.svg' %}');"></span>
                        修改密码
                    </a>
                    <a href="{% url 'delete_account' %}" class="delete-account">
                        <span class="icon" style="-webkit-mask-image: url('{% static 'icons/trash.svg' %}'); mask-image: url('{% static 'icons/trash.svg' %}');"></span>
                        注销账号
                    </a>
                    <hr style="border: 0; border-top: 1px solid var(--primary-color); margin: 0;">
                    <form action="{% url 'logout' %}" method="post" id="logout-form" style="display:none;">
                        {% csrf_token %}
                    </form>
                    <a href="javascript:void(0)" onclick="document.getElementById('logout-form').submit();">
                        <span class="icon" style="-webkit-mask-image: url('{% static 'icons/logout.svg' %}'); mask-image: url('{% static 'icons/logout.svg' %}');"></span>
                        退出登录
                    </a>
                </div>
            </div>
		{% else %}
			<a href="{% url 'login' %}">登录</a>
			<a href="{% url 'register' %}">注册</a>
		{% endif %}
	</div>
</nav>
<div class="{% block container_class %}container{% endblock %}">
    {% block content_wrapper %}
	<div class="card">
		{% block content %}{% endblock %}
	</div>
    {% endblock %}
</div>
<div class="footer-text">
    <p>2026 · 武汉轻工大学 · 精准思政系统</p>
</div>
<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'js/input_components.js' %}"></script>
{% block extra_js %}{% endblock %}
<!--suppress JSUnusedLocalSymbols -->
<script>
    // 隐藏加载动画的函数
    function hideLoader() {
        const loader = document.getElementById('loader-wrapper');
        if (loader) {
            loader.classList.remove('loader-visible');
        }
    }

    // 页面完全加载后隐藏
    window.addEventListener('load', hideLoader);

    // 处理浏览器前进/后退按钮 (bfcache)
    window.addEventListener('pageshow', function(event) {
        // 如果页面是从缓存中恢复的，强制隐藏加载动画
        hideLoader();
    });

    // 页面跳转时显示加载动画（但排除某些特殊情况）
    let isNonNavigationClick = false;
    
    document.addEventListener('click', function(e) {
        const link = e.target.closest('a');
        if (link && link.href) {
            // 检测是否为不导致页面跳转的链接
            if (link.hasAttribute('download') || 
                link.href.startsWith('mailto:') || 
                link.href.startsWith('tel:') ||
                link.target === '_blank') {
                isNonNavigationClick = true;
                // 100ms 后重置标记
                setTimeout(() => { isNonNavigationClick = false; }, 100);
            }
        }
    }, true);  // 使用捕获阶段，确保在 beforeunload 之前执行

    window.addEventListener('beforeunload', function() {
        if (!isNonNavigationClick) {
            document.getElementById('loader-wrapper').classList.add('loader-visible');
        }
    });

    // 兼容部分浏览器点击链接不触发 beforeunload 的情况
    document.addEventListener('click', function(e) {
        const link = e.target.closest('a');
        if (link && 
            link.href && 
            link.href.startsWith(window.location.origin) && 
            !link.target && 
            !link.href.includes('#') &&
            !link.href.includes('javascript:') &&
            !link.hasAttribute('download') &&  // 排除下载链接
            !link.href.startsWith('mailto:') &&  // 排除邮件链接
            !link.href.startsWith('tel:')) {  // 排除电话链接
            document.getElementById('loader-wrapper').classList.add('loader-visible');
        }
    });
</script>
</body>
</html>
